- name: Install Attacker Host
  hosts: attacker
  become: true
  vars:
    attacker_user: aecid
    client_user: judy
    attacker_ip: 192.42.1.174
    ansible_ssh_private_key_file: ~/.ssh/testbed
  handlers:
    - name: restart dnsmasq
      ansible.builtin.service:
        name: dnsmasq
        state: restarted
      delegate_to: inetdns

    - name: restart msfrpcd
      ansible.builtin.service:
        name: msfrpcd
        state: restarted

  tasks:
    - name: get user home directory
      ansible.builtin.shell: >
             getent passwd {{ attacker_user }}  | awk -F: '{ print $6 }'
      changed_when: false
      register: user_home
      tags:
        - playbooks

    - name: Install dependencies
      ansible.builtin.apt:
        pkg:
          - xz-utils
          - coreutils
      tags:
        - playbooks

    - name: Install Flask
      ansible.builtin.pip:
        name: flask
        state: present
      tags:
        - playbooks


    - name: Add attacker IP to DNS
      ansible.builtin.copy:
        content: |
          address=/facebook.com/{{ attacker_ip }}
          address=/suspicious-website.com/{{ attacker_ip }}
        owner: root
        dest: /etc/dnsmasq.d/attacker.conf
      notify: restart dnsmasq
      delegate_to: inetdns
      tags:
        - playbooks


    - name: Install clipboard utilities on client
      become_user: "{{ client_user }}"
      ansible.builtin.apt:
        pkg:
          - xclip
          - xsel
        state: present
      delegate_to: client
      tags:
        - playbooks
        - clipboard




    - name: Copy serverscript
      become: True
      become_user: "{{attacker_user}}"
      ansible.builtin.template:
          src: "http_server.py"
          dest: "{{user_home.stdout}}/http_server.py"
          mode: '0755'
      tags:
         - playbooks

    - name: Run server.py with Python
      ansible.builtin.shell: >
        nohup python3 {{ user_home.stdout }}/http_server.py &
      args:
        executable: /bin/bash
      tags:
        - playbooks

    - name: Copy playbooks
      become: True
      become_user: "{{attacker_user}}"
      ansible.builtin.template:
          src: "{{ item }}.j2"
          dest: "{{user_home.stdout}}/{{ item }}.yml"
          mode: '0755'
      loop:
          - scenario_6_a
      tags:
         - playbooks

    - name: "Run Scenario 6 a"
      become: True
      become_user: "{{attacker_user}}"
      ansible.builtin.shell:
          cmd: "/usr/local/bin/attackmate-tmux scenario_6_a.yml"
          chdir: "{{user_home.stdout}}"
      tags:
         - scenario_6_a
         - metasploit
         - attackmate
         - exploit

